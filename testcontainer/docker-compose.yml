# SPDX-License-Identifier: Apache-2.0
# SPDX-FileCopyrightText: 2025 The Contributors to Eclipse OpenSOVD (see CONTRIBUTORS)
#
# See the NOTICE file(s) distributed with this work for additional
# information regarding copyright ownership.
#
# This program and the accompanying materials are made available under the
# terms of the Apache License Version 2.0 which is available at
# https://www.apache.org/licenses/LICENSE-2.0

services:
  ecu-sim:
    build:
      context: ./ecu-sim
      dockerfile: docker/Dockerfile
    privileged: true
    cap_add:
      - NET_ADMIN
    environment:
      - USE_MULTIPLE_IPS=true
      - SIM_NETWORK_INTERFACE=eth0
    ports:
      - "${SIM_CONTROL_PORT:-8181}:8181"
    networks:
      - testcontainer-net
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8181/ || exit 1"]
      interval: 1s
      timeout: 5s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  cda:
    build:
      context: ..
      dockerfile: testcontainer/cda/Dockerfile
      args:
        - SOURCE_DATE_EPOCH
        - SOURCE_GIT_SHA
    ports:
      - "${CDA_PORT:-20002}:20002"
    volumes:
      - ./odx:/app/odx:ro
    hostname: cda
    networks:
      - testcontainer-net
    depends_on:
      ecu-sim:
        condition: service_healthy
    environment:
      - RUST_LOG=debug
    command: ["-d", "/app/odx"]
    restart: unless-stopped

networks:
  testcontainer-net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.42.0.0/16
